<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>英文句子测评</title>
  <script src="https://sdk.cloud.chivox.com/chivoxsdk-js/v6.0/chivox.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 10px; font-size: 16px; margin: 5px 0; }
    button { user-select: none; }
    #result { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>英文句子测评</h2>
  <input type="text" id="sentenceInput" placeholder="请输入英文句子" style="width: 100%;" />
  <br>
  <button id="startBtn">开始录音</button>
  <button id="stopBtn" disabled>结束录音</button>
  <div id="result">测评结果将在此显示</div>
  <div id="wordTableContainer"></div>

  <script>
    let recorder = null;
    let isRecording = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultDiv = document.getElementById('result');

    // 初始化评测引擎
    function initRecorder() {
      recorder = new Html5Recorder({
        appKey: "16551899080000a5",
        sigurl: "https://collection.91tszx.com/api/Contact/JSSDKsign",
        userId: "gabby_user_001", // 可自定义用户标识
        onInit: () => {
          console.log("✅ SDK 初始化成功");
          startBtn.disabled = false;
        },
        onError: err => {
          console.error("❌ SDK 初始化失败", err);
          resultDiv.textContent = "初始化失败：" + JSON.stringify(err);
        }
      });
    }

    // 开始录音
    startBtn.onclick = () => {
      const sentence = document.getElementById('sentenceInput').value.trim();
      if (!sentence) {
        alert("请输入英文句子");
        return;
      }

      if (!recorder) {
        alert("录音引擎未初始化");
        return;
      }

      isRecording = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      resultDiv.textContent = "🎙 正在录音，请朗读句子...";

      recorder.record({
        serverParams: {
          coreType: "en.sent.pron",
          refText: sentence,
          rank: 100,
          attachAudioUrl: 1
        },
        duration: 10000, // 最大录音时长（毫秒）
        onScore: result => {
          console.log("✅ 测评原始 JSON：", result);
          resultDiv.textContent = formatResult(result);
        },
        onScoreError: err => {
          console.error("❌ 测评失败", err);
          resultDiv.textContent = "测评失败：" + JSON.stringify(err);
        },
        onStart: () => {
         console.log("📤 录音开始，正在处理...");
        },
        onStop: () => {
          console.log("📤 录音结束，正在处理...");
        }
      });
    };

    // 结束录音并释放麦克风
    stopBtn.onclick = () => {
      if (isRecording && recorder) {
        recorder.stopRecord(); // ✅ 正确的停止方法
        isRecording = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    // 格式化测评结果
    function formatResult(result) {
  if (!result || !result.result || !result.result.details?.en?.words) {
    return "无有效结果";
  }

  const { overall, fluency, integrity, accuracy } = result.result;
  const words = result.result.details;

  let summary = `✅ 测评完成：
总分：${overall}
流利度：${fluency}
完整度：${integrity}
准确度：${accuracy}`;

  let tableHTML = `
    <table border="1" cellpadding="6" style="margin-top:10px; border-collapse: collapse; width:100%;">
      <thead>
        <tr style="background:#eee;">
          <th>序号</th>
          <th>单词</th>
          <th>得分</th>
          <th>发音状态</th>
          <th>纠正建议</th>
          <th>音素详情</th>
        </tr>
      </thead>
      <tbody>
  `;

  words.forEach((word, index) => {
    const phoneDetails = word.phones?.map(phone => {
      return `${phone.phone}(${phone.score}, ${phone.dp_message})`;
    }).join(", ") || "—";

    tableHTML += `
      <tr>
        <td>${index + 1}</td>
        <td>${word.text}</td>
        <td>${word.score}</td>
        <td>${word.dp_message}</td>
        <td>${word.suggestion || "—"}</td>
        <td>${phoneDetails}</td>
      </tr>
    `;
  });

  tableHTML += `</tbody></table>`;

  document.getElementById("result").textContent = summary;
  document.getElementById("wordTableContainer").innerHTML = tableHTML;

  return summary;
}


    // 页面加载时初始化 SDK
    window.onload = initRecorder;
  </script>
</body>
</html>

