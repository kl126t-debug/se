<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>è‹±æ–‡å¥å­æµ‹è¯„</title>
  <script src="https://sdk.cloud.chivox.com/chivoxsdk-js/v6.0/chivox.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 10px; font-size: 16px; margin: 5px 0; }
    button { user-select: none; }
    #result { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>è‹±æ–‡å¥å­æµ‹è¯„</h2>
  <input type="text" id="sentenceInput" placeholder="è¯·è¾“å…¥è‹±æ–‡å¥å­" style="width: 100%;" />
  <br>
  <button id="startBtn">å¼€å§‹å½•éŸ³</button>
  <button id="stopBtn" disabled>ç»“æŸå½•éŸ³</button>
  <div id="result">æµ‹è¯„ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º</div>
  <div id="wordTableContainer"></div>

  <script>
    let recorder = null;
    let isRecording = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultDiv = document.getElementById('result');

    // åˆå§‹åŒ–è¯„æµ‹å¼•æ“
    function initRecorder() {
      recorder = new Html5Recorder({
        appKey: "16551899080000a5",
        sigurl: "https://collection.91tszx.com/api/Contact/JSSDKsign",
        userId: "gabby_user_001", // å¯è‡ªå®šä¹‰ç”¨æˆ·æ ‡è¯†
        onInit: () => {
          console.log("âœ… SDK åˆå§‹åŒ–æˆåŠŸ");
          startBtn.disabled = false;
        },
        onError: err => {
          console.error("âŒ SDK åˆå§‹åŒ–å¤±è´¥", err);
          resultDiv.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼š" + JSON.stringify(err);
        }
      });
    }

    // å¼€å§‹å½•éŸ³
    startBtn.onclick = () => {
      const sentence = document.getElementById('sentenceInput').value.trim();
      if (!sentence) {
        alert("è¯·è¾“å…¥è‹±æ–‡å¥å­");
        return;
      }

      if (!recorder) {
        alert("å½•éŸ³å¼•æ“æœªåˆå§‹åŒ–");
        return;
      }

      isRecording = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      resultDiv.textContent = "ğŸ™ æ­£åœ¨å½•éŸ³ï¼Œè¯·æœ—è¯»å¥å­...";

      recorder.record({
        serverParams: {
          coreType: "en.sent.pron",
          refText: sentence,
          rank: 100,
          attachAudioUrl: 1
        },
        duration: 10000, // æœ€å¤§å½•éŸ³æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        onScore: result => {
          console.log("âœ… æµ‹è¯„åŸå§‹ JSONï¼š", result);
          resultDiv.textContent = formatResult(result);
        },
        onScoreError: err => {
          console.error("âŒ æµ‹è¯„å¤±è´¥", err);
          resultDiv.textContent = "æµ‹è¯„å¤±è´¥ï¼š" + JSON.stringify(err);
        },
        onStart: () => {
         console.log("ğŸ“¤ å½•éŸ³å¼€å§‹ï¼Œæ­£åœ¨å¤„ç†...");
        },
        onStop: () => {
          console.log("ğŸ“¤ å½•éŸ³ç»“æŸï¼Œæ­£åœ¨å¤„ç†...");
        }
      });
    };

    // ç»“æŸå½•éŸ³å¹¶é‡Šæ”¾éº¦å…‹é£
    stopBtn.onclick = () => {
      if (isRecording && recorder) {
        recorder.stopRecord(); // âœ… æ­£ç¡®çš„åœæ­¢æ–¹æ³•
        isRecording = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    // æ ¼å¼åŒ–æµ‹è¯„ç»“æœ
    function formatResult(result) {
  if (!result || !result.result || !result.result.details?.en?.words) {
    return "æ— æœ‰æ•ˆç»“æœ";
  }

  const { overall, fluency, integrity, accuracy } = result.result;
  const words = result.result.details;

  let summary = `âœ… æµ‹è¯„å®Œæˆï¼š
æ€»åˆ†ï¼š${overall}
æµåˆ©åº¦ï¼š${fluency}
å®Œæ•´åº¦ï¼š${integrity}
å‡†ç¡®åº¦ï¼š${accuracy}`;

  let tableHTML = `
    <table border="1" cellpadding="6" style="margin-top:10px; border-collapse: collapse; width:100%;">
      <thead>
        <tr style="background:#eee;">
          <th>åºå·</th>
          <th>å•è¯</th>
          <th>å¾—åˆ†</th>
          <th>å‘éŸ³çŠ¶æ€</th>
          <th>çº æ­£å»ºè®®</th>
          <th>éŸ³ç´ è¯¦æƒ…</th>
        </tr>
      </thead>
      <tbody>
  `;

  words.forEach((word, index) => {
    const phoneDetails = word.phones?.map(phone => {
      return `${phone.phone}(${phone.score}, ${phone.dp_message})`;
    }).join(", ") || "â€”";

    tableHTML += `
      <tr>
        <td>${index + 1}</td>
        <td>${word.text}</td>
        <td>${word.score}</td>
        <td>${word.dp_message}</td>
        <td>${word.suggestion || "â€”"}</td>
        <td>${phoneDetails}</td>
      </tr>
    `;
  });

  tableHTML += `</tbody></table>`;

  document.getElementById("result").textContent = summary;
  document.getElementById("wordTableContainer").innerHTML = tableHTML;

  return summary;
}


    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– SDK
    window.onload = initRecorder;
  </script>
</body>
</html>

